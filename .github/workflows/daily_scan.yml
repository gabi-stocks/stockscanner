import yfinance as yf
import pandas as pd
import requests

def get_detailed_info(ticker):
    try:
        stock = yf.Ticker(ticker)
        # ××©×™×›×ª ×—×“×©×•×ª
        news = stock.news[:2]
        news_links = []
        for n in news:
            title = n.get('title', 'News')
            link = n.get('link', '#')
            news_links.append(f"â€¢ <a href='{link}' target='_blank'>{title}</a>")
        
        # ××©×™×›×ª ××™× ×¡×™×™×“×¨×™×
        insider = stock.insider_transactions
        insider_val = "No Recent Data"
        if insider is not None and not insider.empty:
            insider_val = f"{insider.iloc[0].get('Text', 'Transaction Reported')}"
            
        return "<br>".join(news_links) if news_links else "No News", insider_val
    except:
        return "No News", "No Data"

def run_scanner():
    # ×¨×©×™××” ×‘×¡×™×¡×™×ª - ××¤×©×¨ ×œ×”×•×¡×™×£ ×›××Ÿ ×× ×™×•×ª × ×•×¡×¤×•×ª
    tickers = ["AAPL", "MSFT", "NVDA", "TSLA", "INTC", "PYPL", "DIS", "BA", "AVGO", "AMD", "META", "GOOGL", "AMZN", "NFLX"] 
    results = []
    
    print(f"Starting scan for {len(tickers)} stocks...")
    
    for ticker in tickers:
        try:
            # ×”×•×¨×“×ª × ×ª×•× ×™×
            df = yf.download(ticker, period="2y", progress=False)
            if df.empty or len(df) < 151:
                continue
            
            # × ×™×§×•×™ ×›×•×ª×¨×•×ª (×¢×‘×•×¨ ×’×¨×¡××•×ª yfinance ×—×“×©×•×ª)
            if isinstance(df.columns, pd.MultiIndex):
                df.columns = df.columns.get_level_values(0)
            
            # ×—×™×©×•×‘ ×××•×¦×¢×™× ×™×“× ×™ (×‘××§×•× pandas_ta)
            df['MA50'] = df['Close'].rolling(window=50).mean()
            df['MA150'] = df['Close'].rolling(window=150).mean()
            
            price = float(df['Close'].iloc[-1])
            ma50 = float(df['MA50'].iloc[-1])
            ma150 = float(df['MA150'].iloc[-1])
            
            # ×—×™×©×•×‘ ×•×•×œ×™×•× ×™×—×¡×™ (RVOL)
            avg_vol = df['Volume'].rolling(window=20).mean().iloc[-1]
            rvol = float(df['Volume'].iloc[-1] / avg_vol) if avg_vol != 0 else 0
            
            # ×—×™×©×•×‘ ×™×¨×™×“×” ×©×œ 6 ×—×•×“×©×™× (× ×¨ 126 ××—×•×¨×”)
            p_6m = float(df['Close'].iloc[-126])
            drop_6m = ((price - p_6m) / p_6m) * 100
            
            # ×‘×“×™×§×ª ×ª× ××™×: ××¨×—×§ ×©×œ ×¢×“ 5% ××”×××•×¦×¢×™×
            dist_50 = abs((price - ma50) / ma50) * 100
            dist_150 = abs((price - ma150) / ma150) * 100
            
            if dist_50 < 5 or dist_150 < 5:
                news, insider = get_detailed_info(ticker)
                results.append({
                    "Ticker": ticker,
                    "Price": f"{price:.2f}$",
                    "Type": "<span style='color: #d9534f; font-weight: bold;'>ğŸ’ RECOVERY</span>" if drop_6m < -30 else "Standard",
                    "Condition": "Near MA50" if dist_50 < 5 else "Near MA150",
                    "RVOL": f"{rvol:.2f}",
                    "Insider": insider,
                    "Latest News": news
                })
        except Exception as e:
            print(f"Skipping {ticker} due to error: {e}")
            continue

    # ×™×¦×™×¨×ª ×§×•×‘×¥ ×”-HTML
    if results:
        df_final = pd.DataFrame(results)
        html_content = f"""
        <html>
        <head>
            <meta charset="UTF-8">
            <style>
                body {{ font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 40px; background-color: #f8f9fa; }}
                h1 {{ color: #343a40; border-bottom: 2px solid #007bff; padding-bottom: 10px; }}
                table {{ border-collapse: collapse; width: 100%; background: white; box-shadow: 0 4px 8px rgba(0,0,0,0.1); border-radius: 8px; }}
                th {{ background-color: #007bff; color: white; padding: 15px; text-align: left; }}
                td {{ padding: 15px; border-bottom: 1px solid #dee2e6; vertical-align: top; line-height: 1.4; }}
                tr:hover {{ background-color: #f1f3f5; }}
                a {{ color: #007bff; text-decoration: none; }}
                a:hover {{ text-decoration: underline; }}
            </style>
        </head>
        <body>
            <h1>ğŸ“ˆ Stock Breakout & Recovery Report</h1>
            <p>Report generated on: {pd.Timestamp.now().strftime('%Y-%m-%d %H:%M')}</p>
            {df_final.to_html(escape=False, index=False)}
        </body>
        </html>
        """
        with open("index.html", "w", encoding="utf-8") as f:
            f.write(html_content)
    else:
        with open("index.html", "w", encoding="utf-8") as f:
            f.write("<html><body style='font-family: sans-serif; padding: 50px;'><h1>No stocks met the criteria today.</h1></body></html>")

if __name__ == "__main__":
    run_scanner()
